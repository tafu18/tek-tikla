name: Android Build (EAS Local)

on:
  # Bu kÄ±sÄ±m, GitHub arayÃ¼zÃ¼nden butona basarak tetiklemeyi saÄŸlar
  workflow_dispatch:
    inputs:
      app_name:
        description: 'Uygulama (Loglarda gÃ¶rÃ¼nmesi iÃ§in)'
        required: true
        default: 'VaktiHuzur'
        type: choice
        options:
        - VaktiHuzur
        - TekTikla
      profile:
        description: 'Build Profili'
        required: true
        default: 'preview'
        type: choice
        options:
        - preview
        - production
        - development

jobs:
  build:
    name: Build ${{ inputs.app_name }} - ${{ inputs.profile }}
    runs-on: ubuntu-latest
    
    steps:
      # 1. KodlarÄ± Ã‡ek
      - name: ğŸ— Repo Checkout
        uses: actions/checkout@v4

      # 2. Java Kurulumu (Android build iÃ§in ÅŸart)
      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # 3. Node.js ve Cache Kurulumu
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      # 4. Gradle Cache (Build hÄ±zÄ±nÄ± artÄ±rÄ±r)
      - name: ğŸ˜ Gradle Cache
        uses: gradle/actions/setup-gradle@v3

      # 5. BaÄŸÄ±mlÄ±lÄ±klarÄ± YÃ¼kle
      - name: ğŸ“¦ Install Dependencies
        run: |
          npm install -g eas-cli
          npm install

      # 6. Build Ä°ÅŸlemi (EAS Local)
      # --local bayraÄŸÄ± ile Expo sunucularÄ±nÄ± deÄŸil, GitHub Runner'Ä± kullanÄ±rÄ±z.
      # --non-interactive: Soru sormadan devam etmesi iÃ§in.
      - name: ğŸš€ Run EAS Build
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          npx eas-cli build --platform android --profile ${{ inputs.profile }} --local --non-interactive --output ./app-build.apk

      # 7. Dosya UzantÄ±sÄ±nÄ± DÃ¼zeltme (AAB ise ismini dÃ¼zeltelim)
      # EÄŸer production ise Ã§Ä±ktÄ± muhtemelen .aab olacaktÄ±r, eas local Ã§Ä±ktÄ±sÄ±nÄ± kontrol edelim.
      # Basitlik adÄ±na yukarÄ±da Ã§Ä±ktÄ±yÄ± sabit 'app-build.apk' yaptÄ±k ama production AAB Ã¼retir.
      # AÅŸaÄŸÄ±daki adÄ±m dosya tÃ¼rÃ¼nÃ¼ algÄ±layÄ±p artifact'e doÄŸru isimle yÃ¼kler.

      - name: ğŸ“‚ Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.app_name }}-${{ inputs.profile }}-build
          path: |
            ./app-build.apk
            ./*.aab
            ./*.apk
          retention-days: 30
