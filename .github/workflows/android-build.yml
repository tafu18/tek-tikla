name: Tek TÄ±kla Android Build (HÄ±zlÄ±)

on:
  workflow_dispatch:
    inputs:
      profile:
        description: 'Build Profili'
        required: true
        default: 'preview'
        type: choice
        options:
        - preview
        - production
        - development

jobs:
  build:
    name: Build Tek TÄ±kla - ${{ inputs.profile }}
    runs-on: ubuntu-latest
    
    steps:
      # 1. KodlarÄ± Ã‡ek
      - name: ğŸ— Repo Checkout
        uses: actions/checkout@v4

      # 2. Java Kurulumu (Java 17 Android buildleri iÃ§in ideal)
      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # 3. Node.js Kurulumu
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      # 4. Gradle AyarlarÄ±nÄ± Optimize Et (EN Ã–NEMLÄ° ADIM)
      # GitHub Runner'Ä±n RAM'ini verimli kullanmasÄ± ve paralel iÅŸlem yapmasÄ± iÃ§in.
      - name: âš™ï¸ Setup Gradle Config
        run: |
          mkdir -p ~/.gradle
          echo "org.gradle.jvmargs=-Xmx4g -XX:MaxMetaspaceSize=512m -XX:+HeapDumpOnOutOfMemoryError" >> ~/.gradle/gradle.properties
          echo "org.gradle.parallel=true" >> ~/.gradle/gradle.properties
          echo "org.gradle.caching=true" >> ~/.gradle/gradle.properties
          echo "org.gradle.configureondemand=true" >> ~/.gradle/gradle.properties

      # 5. Gradle Cache (Build-cache aktif edildi)
      # build-cache-enabled: true parametresi gradle'Ä±n Ã¶nceki derlemelerden kalan parÃ§alarÄ± kullanmasÄ±nÄ± saÄŸlar.
      - name: ğŸ˜ Gradle Cache
        uses: gradle/actions/setup-gradle@v3
        with:
          cache-read-only: false # Cache'e yazmasÄ±na izin ver
          gradle-home-cache-cleanup: true

      # 6. BaÄŸÄ±mlÄ±lÄ±klarÄ± HÄ±zlÄ± YÃ¼kle (npm ci)
      # npm install yerine npm ci kullanÄ±yoruz. package-lock.json ÅŸarttÄ±r!
      - name: ğŸ“¦ Install Dependencies
        run: |
          npm install -g eas-cli
          npm ci 

      # 7. Build Ä°ÅŸlemi
      - name: ğŸš€ Run EAS Build
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
          GRADLE_OPTS: '-Dorg.gradle.daemon=false' # GitHub runner'da daemon bazen sorun Ã§Ä±karÄ±r, process bazlÄ± cache kullanÄ±yoruz.
        run: |
          EXT="apk"
          if [ "${{ inputs.profile }}" == "production" ]; then
            EXT="aab"
          fi
          
          echo "Build uzantÄ±sÄ±: $EXT olarak ayarlandÄ±."
          
          # --local build iÅŸleminde gradle cache'i kullanabilmek iÃ§in environment variable Ã¶nemli
          npx eas-cli build --platform android --profile ${{ inputs.profile }} --local --non-interactive --output ./tektikla-build.$EXT

      # 8. DosyayÄ± Artifact Olarak YÃ¼kle
      - name: ğŸ“‚ Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: TekTikla-${{ inputs.profile }}-build
          path: |
            ./*.apk
            ./*.aab
          retention-days: 5
